#!/usr/bin/python
__doc__ = 'INFERPROPS -- infer properties of specified neutron star using universal relations and given canonical tidal deformability constraint'
__usage__ = 'inferprops nsname [-v] [-p R,I,Lambda,C,chi] [-M 1.4,0.1] [-L 190,390] [-o ./dat/]'
__author__ = 'philippe.landry@ligo.org'
__date__ = '04-2019'

import numpy as np
from numpy.random import uniform
from optparse import OptionParser
from nsurinf.distributions import *
from nsurinf.universalrelationfits import *
from nsurinf.universalrelationerror import * 

parser = OptionParser(usage=__usage__, description=__doc__)
parser.add_option('-p', '--props', default='R,I,Lambda,C,chi', help='properties to infer, DEFAULT="R,I,Lambda,C,chi"', metavar='PROP1,PROP2')
parser.add_option('-M', '--mgauss', default='1.4,0.1', help='median and standard deviation for Gaussian uncertainty in stellar mass, DEFAULT=1.4,0.1', metavar='MED,STD')
parser.add_option('-L', '--Lgauss', default='190,390', help='median and standard deviation for Gaussian uncertainty in canonical deformability from observations, DEFAULT=190,390', metavar='MED,STD')
parser.add_option('-O', '--omegagauss', default='276.80,1e-6', help='median and standard deviation for Gaussian uncertainty in rotational frequency [rad/s], DEFAULT=276.80,1e-6', metavar='MED,STD')
parser.add_option('-n', '--numsamps', default=1e4, help='number of samples to use for Monte-Carlo integration, DEFAULT=1e4', metavar='NUM_SAMPS')
parser.add_option('-o', '--outdir', default='./dat/', help='path to output directory, DEFAULT=./dat/', metavar='PATH/TO/OUTDIR')
parser.add_option('-t', '--tag', default='_props', help='tag for output data file NSNAME_TAG.csv, DEFAULT=_props', metavar='_TAG')
parser.add_option('-v', '--verbose', action='store_true', default=False, help='toggle verbose output, DEFAULT=False', metavar='False')
parser.add_option('-u', '--uniform', action='store_true', default=False, help='toggle uniform vs Gaussian mass prior, DEFAULT=False', metavar='BOOL')
parser.add_option('-T', '--truncate', default=False, help='toggle truncation of Gaussian mass prior, DEFAULT=FALSE', metavar='MASS_UB')
parser.add_option('-b', '--beta', default=False, help='toggle beta-prime vs Gaussian Lambda_1.4 prior, DEFAULT=False', metavar='P,Q')

opts, args = parser.parse_args()
nsname = str(args[0])
props = str(opts.props)
props = props.split(',')
mgauss = str(opts.mgauss)
mgauss = mgauss.split(',')
mmed, mstd = [float(mparam) for mparam in mgauss]
Lgauss = str(opts.Lgauss)
Lgauss = Lgauss.split(',')
Lmed, Lstd = [float(Lparam) for Lparam in Lgauss]
omegagauss = str(opts.omegagauss)
omegagauss = omegagauss.split(',')
omegamed, omegastd = [float(omegaparam) for omegaparam in omegagauss]
nsamps = float(opts.numsamps)
nsamps = int(nsamps)
outdir = str(opts.outdir)
tag = str(opts.tag)
verb = opts.verbose
unif = opts.uniform
beta = str(opts.beta).split(',')
p,q = [float(betaparam) for betaparam in beta]
trunc = opts.truncate
if trunc: mub = float(trunc)

outfile = open(outdir+nsname+tag+".csv","w")
outfile.write('Lambda_14,M,'+','.join(props)+'\n')

# LOAD UNIVERSAL RELATION FITS WITH MARGINALIZED UNCERTAINTIES

ur = {'R': RLove,'I': ILove,'Lambda': CanonBiLove,'C': CLove,'chi': chiLove}

# SAMPLE FROM POSTERIORS ON LAMBDA_1.4 AND M

if verb:	print 'Sampling from observed canonical deformability and target mass distributions'

if not beta:
	Lsamps = posnormal(Lmed,Lstd,nsamps)
else:
	Lsamps = genbetaprime(p,q,Lmed,Lstd,nsamps)

if not unif:
	if trunc: msamps = truncnormal(mmed,mstd,mub,nsamps)
	else: msamps = posnormal(mmed,mstd,nsamps)
else:
	msamps = uniform(mmed,mstd,nsamps)

omegasamps = posnormal(omegamed,omegastd,nsamps)

# PERFORM BAYESIAN INFERENCE OF PROPERTIES VIA MONTE-CARLO INTEGRATION

if verb:	print 'Performing Monte-Carlo integration with {0} samples'.format(nsamps)

for samp in range(nsamps):

	if verb:	print 'Computing properties for sample {0}'.format(samp)

	msamp = msamps[samp]
	Lsamp = Lsamps[samp]
	omegasamp = omegasamps[samp] # COULD ALSO SAMPLE THESE SEPARATELY IF MORE EFFICIENT

	propvals = []
	for prop in props:
	
		if prop == 'chi':
			propval = ur['chi'](msamp,Lsamp,omegasamp)
	
		else:
			propval = ur[prop](msamp,Lsamp)
	
		propvals.append(propval)
		
	propvalsout = ['{0:.3e}'.format(item) for item in propvals]

	outfile.write('{0:.3e},{1:.6f},'.format(Lsamp,msamp)+','.join(propvalsout)+'\n')

if verb:	print 'Done Monte-Carlo integration'
